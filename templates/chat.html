{# â”€â”€ templates/chat.html â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% extends "_base.html" %}
{% set active = "/chat" %}
{% set page_title = "Chat" %}

{% block body %}
<div class="flex h-[calc(100vh-4rem)] bg-gradient-to-br from-gray-50 to-gray-100">

  {# â”€â”€ sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <aside class="w-64 border-r border-gray-200 bg-white/70 backdrop-blur p-4 overflow-auto">
    <h2 class="font-semibold mb-2">Candidates</h2>
    <input id="filter" type="text"
           placeholder="filterâ€¦" 
           class="mb-3 w-full border px-2 py-1 rounded" />
    <div id="cand-list" class="space-y-1 text-sm">
      {% for c in candidates %}
      <label class="flex items-center space-x-2">
        <input type="checkbox" value="{{ c.id }}" class="candidate-box">
        <span>{{ c.name }}</span>
      </label>
      {% endfor %}
    </div>
  </aside>

  {# â”€â”€ main chat column â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <main class="flex-1 flex flex-col h-full">
    <div id="chat-box" class="flex-1 overflow-auto p-6 space-y-3">
      {% for msg in history %}
      <div class="max-w-prose {{ 'ml-auto text-right' if msg.role=='user' else '' }}">
        <div class="rounded-xl px-4 py-2
                    {{ 'bg-blue-100' if msg.role=='user' else 'bg-rose-100' }}
                    whitespace-pre-wrap">
          <strong>{{ 'You' if msg.role=='user' else 'Assistant' }}:</strong>
          {{ msg.content|safe }}
        </div>
      </div>
      {% endfor %}
    </div>

    {# input row #}
    <div class="border-t bg-white/70 backdrop-blur p-4 flex items-center gap-2">
      <button id="attach-btn" title="Upload project"
              class="p-2 rounded bg-gray-200">ðŸ“Ž</button>
      <input id="project-file" type="file" accept=".pdf,.docx" class="hidden">
      <input id="chat-input" type="text"
             placeholder="Type a messageâ€¦"
             class="flex-1 border px-3 py-2 rounded">
      <button id="send-btn"
              class="bg-blue-600 text-white px-4 py-2 rounded">
        Send
      </button>
    </div>
  </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
const qs = s => document.querySelector(s);

// â”€â”€ helper: currently-selected candidate IDs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selected() {
  return [...document.querySelectorAll('.candidate-box:checked')]
         .map(x => x.value);
}

// â”€â”€ helper: append chat bubble and auto-scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addBubble(role, html) {
  const align = role === 'user' ? 'ml-auto text-right' : '';
  const bg    = role === 'user' ? 'bg-blue-100'          : 'bg-rose-100';
  qs('#chat-box').insertAdjacentHTML('beforeend',
    `<div class="max-w-prose ${align}">
       <div class="rounded-xl px-4 py-2 ${bg} whitespace-pre-wrap">
         <strong>${role === 'user' ? 'You' : 'Assistant'}:</strong> ${html}
       </div>
     </div>`);
  qs('#chat-box').scrollTop = qs('#chat-box').scrollHeight;
}

// â”€â”€ sidebar filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
qs('#filter').oninput = e => {
  const v = e.target.value.toLowerCase();
  document.querySelectorAll('#cand-list label').forEach(lb => {
    lb.style.display = lb.innerText.toLowerCase().includes(v) ? '' : 'none';
  });
};

// â”€â”€ send text message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
qs('#send-btn').onclick = async () => {
  const txt = qs('#chat-input').value.trim();
  if (!txt) return;
  qs('#chat-input').value = '';
  addBubble('user', txt);

  const res = await fetch('/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ text: txt, candidate_ids: selected() })
  });
  const data = await res.json();
  addBubble('assist', data.reply);
};

// â”€â”€ send project file â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
qs('#attach-btn').onclick = () => qs('#project-file').click();
qs('#project-file').onchange = async e => {
  const f = e.target.files[0];
  if (!f) return;
  const fd = new FormData();
  fd.append('file', f);
  selected().forEach(id => fd.append('candidate_ids', id));
  addBubble('user', '[uploaded project]');
  const html = await (await fetch('/match_project', {method: 'POST', body: fd})).text();
  addBubble('assist', html);
  e.target.value = '';
};

// â”€â”€ scroll to bottom on initial load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
  qs('#chat-box').scrollTop = qs('#chat-box').scrollHeight;
});
</script>
{% endblock %}
