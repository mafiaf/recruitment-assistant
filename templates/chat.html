<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Project Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>[v-cloak]{display:none}</style>
</head>
<body class="h-screen flex bg-gray-50">
  <!-- sidebar -->
  <aside class="w-64 border-r bg-white p-4 overflow-auto">
    <h2 class="font-semibold mb-2">Candidates</h2>
    <input type="text" id="filter" placeholder="filterâ€¦" class="mb-3 w-full border px-2 py-1 rounded"/>
    <div id="cand-list" class="space-y-1 text-sm">
      {% for c in candidates %}
      <label class="flex items-center space-x-2">
        <input type="checkbox" value="{{ c.id }}" class="candidate-box"/> <span>{{ c.name }}</span>
      </label>
      {% endfor %}
    </div>
  </aside>
  <!-- main -->
  <main class="flex-1 flex flex-col h-full">
    <div id="chat-box" class="flex-1 overflow-auto p-6 space-y-3">
      {% for msg in history %}
      <div class="max-w-prose {{ 'ml-auto text-right' if msg.role=='user' else '' }}">
        <div class="rounded-xl px-4 py-2 {{ 'bg-blue-100' if msg.role=='user' else 'bg-rose-100' }} whitespace-pre-wrap">
          <strong>{{ 'You' if msg.role=='user' else 'Assistant' }}:</strong>
          {{ msg.content|safe }}
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- input row -->
    <div class="border-t p-4 flex items-center gap-2">
      <button id="attach-btn" class="p-2 rounded bg-gray-200">ðŸ“Ž</button>
      <input type="file" id="project-file" accept=".pdf,.docx" class="hidden" />
      <input type="text" id="chat-input" placeholder="Type a messageâ€¦" class="flex-1 border px-3 py-2 rounded" />
      <button id="send-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Send</button>
    </div>
  </main>

<script>
const qs=s=>document.querySelector(s);
function selected(){return [...document.querySelectorAll('.candidate-box:checked')].map(x=>x.value)}
function addBubble(role,html){
  const cls=role==='user'? 'ml-auto text-right bg-blue-100':'bg-rose-100';
  qs('#chat-box').insertAdjacentHTML('beforeend',`<div class="max-w-prose ${role==='user'?'ml-auto':''}"><div class="rounded-xl px-4 py-2 ${cls} whitespace-pre-wrap"><strong>${role==='user'?'You':'Assistant'}:</strong> ${html}</div></div>`);
  qs('#chat-box').scrollTop=qs('#chat-box').scrollHeight;
}

// search filter sidebar
qs('#filter').oninput=e=>{
  const v=e.target.value.toLowerCase();
  document.querySelectorAll('#cand-list label').forEach(lb=>{
    lb.style.display=lb.innerText.toLowerCase().includes(v)?'':'none';
  });
};

// send text
qs('#send-btn').onclick=async()=>{
  const txt=qs('#chat-input').value.trim();
  if(!txt) return;
  qs('#chat-input').value='';
  addBubble('user',txt);
  const res=await fetch('/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:txt,candidate_ids:selected()})});
  const data=await res.json();
  addBubble('assist',data.reply);
};

// send file
qs('#attach-btn').onclick=()=>qs('#project-file').click();
qs('#project-file').onchange=async e=>{
  const f=e.target.files[0];if(!f) return;
  const fd=new FormData();fd.append('file',f);selected().forEach(id=>fd.append('candidate_ids',id));
  addBubble('user','[uploaded project]');
  const html=await (await fetch('/match_project',{method:'POST',body:fd})).text();
  addBubble('assist',html);
  e.target.value='';
};
</script>
</body>
</html>