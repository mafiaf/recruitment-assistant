{% extends "_base.html" %}
{% set active = "/resumes" %}
{% set page_title = "Résumés" %}

{% block body %}
<div class="pt-6 max-w-6xl mx-auto bg-white/70 backdrop-blur p-6 rounded-xl shadow">

  <!-- search box -->
  <input id="search" type="text" placeholder="Search…"
         class="mb-4 w-64 px-3 py-2 border rounded">

  <!-- server-side filters -->
  <form method="get" class="mb-4 space-x-2 text-sm">
    <input name="skill" placeholder="Skill" value="{{ skill }}"
           class="px-2 py-1 border rounded">
    <input name="location" placeholder="Location" value="{{ location }}"
           class="px-2 py-1 border rounded">
    <input name="min_years" type="number" placeholder="Min years"
           value="{{ min_years }}" class="w-24 px-2 py-1 border rounded">
    <input name="max_years" type="number" placeholder="Max years"
           value="{{ max_years }}" class="w-24 px-2 py-1 border rounded">
    <button class="px-2 py-1 bg-indigo-600 text-white rounded">Filter</button>
  </form>

  <!-- résumé table -->
  <table id="cv-table"
         class="w-full text-sm border rounded-xl overflow-hidden shadow">
    <thead>
      <tr class="bg-gray-100 text-left">
        <th class="px-4 py-2">Name</th>
        <th class="px-2 py-2">Added</th>
        <th class="px-2 py-2">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in resumes %}
      <tr class="odd:bg-white even:bg-gray-50">
        <td class="px-4 py-2">{{ r.name }}</td>
        <td class="px-2 py-2 date-label">{{ r.added|default('—') }}</td>
        <td class="px-2 py-2 space-x-3 text-sm">

        <!-- preview → uses <details>   (no form, just HTML) -->
        <details class="inline">
          <summary class="cursor-pointer text-blue-600 hover:underline">preview</summary>
          <pre class="p-2 bg-gray-100 max-h-60 overflow-auto whitespace-pre-wrap text-xs">
            {{ r.text[:1500] }}{% if r.text|length > 1500 %}…{% endif %}
          </pre>
        </details>

        <!-- EDIT (= GET /edit_resume?id=…)  -->
        <form action="/edit_resume" method="get" class="inline">
          <input type="hidden" name="id" value="{{ r.id }}">
          <!--  ✦ add type="submit" so only this form fires  -->
          <button type="submit" class="text-yellow-600 hover:underline">edit</button>
        </form>

        <!-- DELETE (= POST /delete_resume) -->
        <form action="/delete_resume" method="post" class="inline">
          <input type="hidden" name="id" value="{{ r.id }}">
          <button type="submit"
                  class="text-red-600 hover:underline"
                  onclick="return confirm('Delete résumé?')">
            delete
          </button>
        </form>

      </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="flex justify-between items-center mt-4 text-sm">
    {% if prev_page %}
      <a href="/resumes?page={{ prev_page }}{% if qs %}&{{ qs }}{% endif %}" class="text-blue-600 hover:underline">&laquo; Prev</a>
    {% else %}
      <span></span>
    {% endif %}
    <span>Page {{ page }} of {{ pages }}</span>
    {% if next_page %}
      <a href="/resumes?page={{ next_page }}{% if qs %}&{{ qs }}{% endif %}" class="text-blue-600 hover:underline">Next &raquo;</a>
    {% else %}
      <span></span>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// client-side filter
const rows = [...document.querySelectorAll('#cv-table tbody tr')];
document.getElementById('search').oninput = e=>{
  const q = e.target.value.toLowerCase();
  rows.forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
};
</script>
{% endblock %}
