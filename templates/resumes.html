{% extends "_base.html" %}
{% set active = "/resumes" %}
{% set page_title = "Résumés" %}

{% block body %}
<div class="max-w-6xl mx-auto card">

  <!-- search box -->
  <div class="mb-4">
    <label for="search" class="block mb-1">Search</label>
    <input id="search" type="text" class="w-64">
  </div>

  <!-- server-side filters -->
  <form method="get" class="mb-4 grid grid-cols-2 gap-2 text-sm max-w-md">
    <div>
      <label class="block mb-1">Skill</label>
      <input name="skill" value="{{ skill }}">
    </div>
    <div>
      <label class="block mb-1">Location</label>
      <input name="location" value="{{ location }}">
    </div>
    <div>
      <label class="block mb-1">Min years</label>
      <input name="min_years" type="number" value="{{ min_years }}" class="w-full">
    </div>
    <div>
      <label class="block mb-1">Max years</label>
      <input name="max_years" type="number" value="{{ max_years }}" class="w-full">
    </div>
    <div class="col-span-2">
      <button class="btn w-full">Filter</button>
    </div>
  </form>

  <!-- résumé table -->
  <table id="cv-table" class="w-full text-sm">
    <thead>
      <tr class="bg-gray-100 text-left">
        <th class="px-4 py-2">Name</th>
        <th class="px-2 py-2">Added</th>
        <th class="px-2 py-2">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in resumes %}
      <tr class="odd:bg-white even:bg-gray-50 h-12">
        <td class="px-4 font-bold">{{ r.name }}</td>
        <td class="px-2">{{ r.added|default('—') }}</td>
        <td class="px-2 space-x-2 text-sm">

        <!-- preview → uses <details>   (no form, just HTML) -->
        <details class="inline">
          <summary class="cursor-pointer hover:underline" style="color: var(--color-accent);">preview</summary>
          <pre class="p-2 bg-gray-100 max-h-60 overflow-auto whitespace-pre-wrap text-xs">
            {{ r.text[:1500] }}{% if r.text|length > 1500 %}…{% endif %}
          </pre>
        </details>

        <!-- EDIT (= GET /edit_resume?id=…)  -->
        <form action="/edit_resume" method="get" class="inline">
          <input type="hidden" name="id" value="{{ r.id }}">
          <!--  ✦ add type="submit" so only this form fires  -->
          <button type="submit" title="Edit">✏️</button>
        </form>

        <!-- DELETE (= POST /delete_resume) -->
        <form action="/delete_resume" method="post" class="inline">
          <input type="hidden" name="id" value="{{ r.id }}">
          <button type="submit" title="Delete" onclick="return confirm('Delete résumé?')">🗑️</button>
        </form>

      </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="flex justify-between items-center mt-4 text-sm">
    {% if prev_page %}
      <a href="/resumes?page={{ prev_page }}{% if qs %}&{{ qs }}{% endif %}" class="text-blue-600 hover:underline">&laquo; Prev</a>
    {% else %}
      <span></span>
    {% endif %}
    <span>Page {{ page }} of {{ pages }}</span>
    {% if next_page %}
      <a href="/resumes?page={{ next_page }}{% if qs %}&{{ qs }}{% endif %}" class="text-blue-600 hover:underline">Next &raquo;</a>
    {% else %}
      <span></span>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// client-side filter
const rows = [...document.querySelectorAll('#cv-table tbody tr')];
document.getElementById('search').oninput = e=>{
  const q = e.target.value.toLowerCase();
  rows.forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
};
</script>
{% endblock %}
